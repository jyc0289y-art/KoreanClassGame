# 통합 맵 시스템 대개편 — 현실감 있는 도시 맵 구현

## Context
현재 서울은 명동/강남/홍대/성수 4개, 후쿠오카는 야쿠인 1개로 분리된 1600x1200 작은 씬. 모든 지역이 동일한 grass 타일 + 단순 도로 오버레이로 구성되어 장소 간 차별화가 없고 현실감이 부족함. 사용자 요청: 한 도시의 모든 지역을 하나의 대형 맵에 통합하고, 위성사진/지도 기반의 현실적 지리(한강, 하카타만, 주요도로)를 반영하며, 지하철역을 통한 원거리 이동을 구현.

---

## 1. 아키텍처 변경 요약

### 씬 통합
| 현재 (분리) | → 통합 후 |
|---|---|
| SeoulMyeongdongScene (1600x1200) | **SeoulUnifiedScene** (9600x7200) |
| SeoulGangnamScene (1600x1200) | ↑ 통합 |
| SeoulHongdaeScene (1600x1200) | ↑ 통합 |
| SeoulSeongsuScene (1600x1200) | ↑ 통합 |
| FukuokaYakuinScene (2400x1800) | **FukuokaUnifiedScene** (6400x4800) |

- **FukuokaAirportScene**, **IncheonAirportScene** — 공항 터미널은 실내 씬이므로 독립 유지
- **InternationalMapScene** — 해안선 디테일 강화 (150+ 좌표 한반도, 40+ 규슈, 제주/대마도 추가)

### 성능 최적화: 타일맵 → Graphics 기반 지형
현재 `createTilemap()`은 32x32 Image 객체를 개별 생성 (1600x1200 = 1,875개).
9600x7200이면 **67,500개** Image → 브라우저 크래시 위험.

**해결:** `createTerrainGraphics(zones)` 메서드 신규 — 단일 Phaser.Graphics 객체로 지형 전체를 fillRect/fillPolygon으로 그림. Image 객체 0개.

---

## 2. 서울 통합맵 (SeoulUnifiedScene) — 9600x7200

### 실제 지리 기반 레이아웃

```
Y=0     ─── 북한산/인왕산 (산지대, 짙은 초록) ────────────────
Y=800   ┌─────────────────────────────────────────────────────┐
        │ 홍대 (NW)          명동 (NC)          성수 (NE)     │
        │ X:400-2800        X:3600-6000        X:6800-9200   │
        │ Y:800-3400        Y:800-3400         Y:800-3400    │
        │                                                     │
Y=2800  │  ···종로(Y≈1600)·········세종대로(X≈4800)··········  │
        │                                                     │
Y=3600  ├═══════════════════ 한강 (Y:3600-4200) ══════════════┤
        │     🌉 마포대교      🌉 한남대교      🌉 성수대교     │
        │     X≈1600          X≈4800           X≈7500        │
Y=4200  ├═════════════════════════════════════════════════════┤
        │               강남 (SC)                             │
        │              X:3600-6000                            │
        │              Y:4600-6800                            │
        │  ···테헤란로(Y≈5400)···강남대로(X≈4800)···          │
Y=7200  └─────────────────────────────────────────────────────┘
```

### 지역별 테마 색상
| 지역 | 지면 틴트 | 도로 하이라이트 | 대표 건물 |
|------|----------|---------------|---------|
| 홍대 | 보라 `0xDA70D6` α0.06 | 걷고싶은거리(보라) | 빈티지숍, 카페, K-POP 굿즈샵 |
| 명동 | 핑크 `0xFF69B4` α0.05 | 명동길(핑크) | 올리브숲, 하이코그라운드, 게스트하우스 |
| 성수 | 시안 `0x00CED1` α0.05 | 카페거리(시안) | 팝업스토어, 디자인 스튜디오 |
| 강남 | 골드 `0xFFD700` α0.04 | K-Idol Road(금색) | 삼겹살 식당, 고엑스몰 |

### 지리 요소
- **한강**: Y:3600-4200, 진한 파랑 `0x1a3a6a` 폴리곤, 약간의 곡선 (서→동)
- **3개 다리**: 도로 색상 직사각형 + "🌉 마포대교" 등 라벨
- **주요도로**: 종로(Y≈1600, 동서), 세종대로(X≈4800, 남북), 강남대로(X≈4800, 한강 남쪽), 테헤란로(Y≈5400, 동서)
- **산지대**: Y<600 영역에 짙은 초록 `0x1a3a1a` α0.3
- **비개발지**: 지역 사이 빈 공간은 기본 초록(일반 도시 구역)

### 지하철역 배치 (4개)
| 역명 | 좌표 | 기존 씬의 건물/NPC 이관 |
|------|------|------------------------|
| 홍대입구역 | (1600, 3000) | SeoulHongdaeScene 전체 |
| 명동역 | (4800, 2800) | SeoulMyeongdongScene 전체 |
| 성수역 | (8000, 2800) | SeoulSeongsuScene 전체 |
| 강남역 | (4800, 5800) | SeoulGangnamScene 전체 |

### 진입가능 건물 이관
- 올리브숲 → (4800, 1800) 명동 구역 내
- 하이코그라운드 → (4200, 1400) 명동 구역 내
- 게스트하우스 → (5600, 2200) 명동 구역 내
- 삼겹살 식당 → (5200, 5400) 강남 구역 내

### NPC 이관
기존 4개 씬의 NPC 전부 이관 — 좌표는 해당 지역 구역 내 배치

---

## 3. 후쿠오카 통합맵 (FukuokaUnifiedScene) — 6400x4800

### 실제 지리 기반 레이아웃

```
Y=0     ═══════════ 하카타만 (바다) ═══════════════════════════
Y=800   ━━━━━━━ 해안선 (곡선 폴리곤) ━━━━━━━━━━━━━━━━━━━━━━
        │                  │                                  │
        │ 텐진 (W)    나카강│   하카타 (E)                    │
        │ X:1200-3000      │   X:3800-5600                   │
        │ Y:1000-2400      │   Y:1200-2800                   │
Y=2400  │                  │                                  │
        │ 야쿠인 (SW)      │                                  │
        │ X:1200-3000      │                                  │
        │ Y:2600-4200      │                                  │
Y=4800  └─────────────────────────────────────────────────────┘
```

### 지리 요소
- **하카타만**: Y<800 전체 + 곡선 해안선 (30+ 좌표)
- **나카가와(那珂川)**: X≈3400, 남북으로 흐르는 강 (폭 120px, 파랑)
- **다이하쿠도리(大博通り)**: X≈4600, 남북 주요도로
- **쇼와도리(昭和通り)**: Y≈2000, 동서 주요도로
- **와타나베도리(渡辺通り)**: X≈2400, 텐진~야쿠인 남북도로

### 지역별 테마
| 지역 | 테마 색상 | 특징 |
|------|----------|------|
| 텐진 | 주황 `0xFF8C00` α0.05 | 쇼핑 중심, 백화점, 번화가 |
| 하카타 | 빨강 `0xCD5C5C` α0.04 | JR역 주변, 라멘 거리 |
| 야쿠인 | 초록 `0x2E8B57` α0.05 | 주택가, 학원, 서점 (기존 건물 이관) |

### 기존 YakuinScene 건물/NPC 전체 이관
- 유코집, 아미집, 루이집 → 야쿠인 구역 내
- 서점, 한국어 학원 → 야쿠인 구역 내
- 5 NPC 전부 → 야쿠인 구역 내

### 신규 구역: 텐진, 하카타
- 텐진: 일반 건물 3-4개 + NPC 2명 (향후 ch03+ 장소맵 확장 대비)
- 하카타: 일반 건물 3-4개 + NPC 2명

### 지하철역 배치
| 역명 | 좌표 | 비고 |
|------|------|------|
| 야쿠인역 | (2400, 3800) | 기존 이관 |
| 텐진역 | (2200, 1800) | 신규 (텐진 구역) |
| 하카타역 | (4600, 2000) | 신규 (하카타 구역) |

---

## 4. 국제맵 해안선 강화 (InternationalMapScene)

### 현재 → 개선
| 항목 | 현재 | → 개선 |
|------|-----|--------|
| 한반도 | 28 좌표 (대략적 타원) | 150+ 좌표 (동해안 리아스, 서해안 갯벌, 남해안 섬) |
| 규슈 | 11 좌표 | 40+ 좌표 (아리아케해, 나가사키 반도) |
| 시코쿠+혼슈 | 10 좌표 | 30+ 좌표 |
| 제주도 | 없음 | 추가 (12 좌표) |
| 대마도 | 없음 | 추가 (8 좌표) |
| 지명 라벨 | 없음 | 서울, 부산, 후쿠오카, 도쿄 등 주요 도시 표시 |

---

## 5. BaseWorldScene 변경

### 신규 메서드: `createTerrainGraphics(config)`
```
config = {
  baseColor: 0x2d5a1e,      // 기본 지면 색상
  zones: [                    // 구역별 틴트
    { shape:'rect', x, y, w, h, color, alpha },
    { shape:'polygon', points:[[x,y],...], color, alpha }
  ],
  water: [                    // 수역 (한강 등)
    { points:[[x,y],...], color:0x1a3a6a }
  ],
  roads: [                    // 주요도로
    { x, y, w, h, color:0x555555, alpha:0.7 }
  ]
}
```
- 단일 `this.add.graphics()` 사용 → Image 객체 0개
- 기존 `createTilemap()`은 하위 호환을 위해 유지 (공항, 인천 등 소형 씬)

### 기존 메서드 변경 없음
- `createNPCs()`, `createBuildings()`, `createEnterableBuilding()`, `createSubwayEntrance()`, `createPortal()` — 모두 그대로 사용

---

## 6. 파일 변경 목록

### 신규 생성 (2개)
| 파일 | 설명 |
|------|------|
| `src/scenes/seoul/SeoulUnifiedScene.js` | 서울 통합맵 (9600x7200) |
| `src/scenes/fukuoka/FukuokaUnifiedScene.js` | 후쿠오카 통합맵 (6400x4800) |

### 삭제 (5개)
| 파일 | 대체 |
|------|------|
| `src/scenes/seoul/SeoulMyeongdongScene.js` | → SeoulUnifiedScene |
| `src/scenes/seoul/SeoulGangnamScene.js` | → SeoulUnifiedScene |
| `src/scenes/seoul/SeoulHongdaeScene.js` | → SeoulUnifiedScene |
| `src/scenes/seoul/SeoulSeongsuScene.js` | → SeoulUnifiedScene |
| `src/scenes/fukuoka/FukuokaYakuinScene.js` | → FukuokaUnifiedScene |

### 수정 (8개)
| 파일 | 변경 내용 |
|------|----------|
| `src/scenes/BaseWorldScene.js` | `createTerrainGraphics()` 메서드 추가 |
| `src/scenes/SeoulMetroScene.js` | 모든 station node의 `targetScene` → `'SeoulUnifiedScene'`, `goBack()` 업데이트 |
| `src/scenes/FukuokaMetroScene.js` | station node의 `targetScene` → `'FukuokaUnifiedScene'`, 텐진/하카타역 추가, `goBack()` 업데이트 |
| `src/scenes/InternationalMapScene.js` | 해안선 좌표 교체 (150+ 한반도, 40+ 규슈, 제주/대마도 추가) |
| `src/constants.js` | `MAP_SIZES.SEOUL_UNIFIED`, `MAP_SIZES.FUKUOKA_UNIFIED` 추가 |
| `src/main.js` | import 5개 삭제, 2개 추가 |
| `src/scenes/FukuokaAirportScene.js` | 지하철 targetScene이 현재도 MetroScene이므로 변경 불필요 (확인만) |
| `src/scenes/incheon/IncheonAirportScene.js` | 동일 (확인만) |

### 변경 불필요
- **장소맵 (OliveYoungScene, RestaurantScene 등)**: `returnScene`은 `this._initData.returnScene`으로 동적 전달 → 자동으로 'SeoulUnifiedScene'이 됨
- **BasePlaceScene**: 변경 없음
- **BaseMapUIScene**: 변경 없음

---

## 7. 구현 순서

### Step 1: BaseWorldScene에 createTerrainGraphics() 추가
- 기존 createTilemap()과 공존 (하위 호환)
- 통합 씬에서만 새 메서드 사용

### Step 2: constants.js 업데이트
- SEOUL_UNIFIED, FUKUOKA_UNIFIED 맵 크기 추가

### Step 3: SeoulUnifiedScene.js 생성
- 9600x7200 맵
- 한강, 다리, 주요도로, 4개 지역 구역 그리기
- 기존 4개 씬의 모든 건물/NPC/지하철역 이관
- stationSpawnPoints, placeSpawnPoints 설정

### Step 4: FukuokaUnifiedScene.js 생성
- 6400x4800 맵
- 하카타만, 나카강, 주요도로 그리기
- 기존 야쿠인 건물/NPC 이관 + 텐진/하카타 신규 구역

### Step 5: 메트로 씬 업데이트
- SeoulMetroScene: targetScene → SeoulUnifiedScene
- FukuokaMetroScene: targetScene → FukuokaUnifiedScene, 신규 역 추가

### Step 6: InternationalMapScene 해안선 강화

### Step 7: main.js 업데이트
- 구 씬 import 삭제, 신규 씬 import 추가

### Step 8: 구 씬 파일 삭제

### Step 9: 테스트 및 검증

---

## 8. 검증 방법

1. `npm run dev` → 게임 실행
2. **서울 통합맵 진입**: 메트로에서 각 역 선택 → 올바른 위치에 스폰 확인
3. **건물 진입/퇴장**: 올리브숲, 삼겹살 식당 등 진입 → 나오면 통합맵 올바른 위치에 복귀 확인
4. **지하철 이동**: 홍대역 → 메트로 → 강남역 선택 → 강남 구역에 스폰 확인
5. **후쿠오카 통합맵**: 야쿠인 건물 전부 진입 가능 확인, 텐진/하카타 구역 시각적 확인
6. **국제맵**: 해안선 디테일, 제주도/대마도 표시 확인
7. **성능**: 콘솔에서 FPS 확인, 60fps 유지 확인
8. preview_screenshot으로 시각적 결과 확인
